{% extends "layout.html" %}

{% block title %}Dashboard::System{% endblock %}

{% block content %}
<div class="p-6 h-full pb-20">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-white font-mono">> ./dashboard.sh</h1>
        <span class="px-2 py-1 bg-success/10 text-success border border-success/20 text-xs font-mono rounded">SYSTEM:
            OPTIMAL</span>
    </div>

    <!-- Metrics Grid -->
    <!-- Role-Based Content -->
    {% if user.role.value == 'member' %}
    <!-- MEMBER VIEW -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="terminal-card rounded p-4 bg-[#0d1117] flex flex-col items-center justify-center">
            <h3 class="text-muted text-xs uppercase mb-2">MY_TODO</h3>
            <span class="text-4xl font-mono text-gray-400" id="stat-todo">-</span>
        </div>
        <div class="terminal-card rounded p-4 bg-[#0d1117] flex flex-col items-center justify-center">
            <h3 class="text-muted text-xs uppercase mb-2">IN_PROGRESS</h3>
            <span class="text-4xl font-mono text-primary" id="stat-inprogress">-</span>
        </div>
        <div class="terminal-card rounded p-4 bg-[#0d1117] flex flex-col items-center justify-center">
            <h3 class="text-muted text-xs uppercase mb-2">DONE</h3>
            <span class="text-4xl font-mono text-success" id="stat-done">-</span>
        </div>
    </div>
    <div class="terminal-card rounded overflow-hidden mb-8">
        <div class="terminal-header"><span><i class="fas fa-chart-pie mr-2"></i>MY_PROGRESS</span></div>
        <div class="p-4 bg-[#0d1117] h-40">
            <canvas id="memberChart"></canvas>
        </div>
    </div>

    {% elif user.role.value == 'manager' %}
    <!-- MANAGER VIEW -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Team Status -->
        <div class="terminal-card rounded overflow-hidden">
            <div class="terminal-header"><span><i class="fas fa-chart-doughnut mr-2"></i>TEAM_STATUS</span></div>
            <div class="p-4 bg-[#0d1117] h-40">
                <canvas id="teamStatusChart"></canvas>
            </div>
        </div>
        <!-- Workload -->
        <div class="terminal-card rounded overflow-hidden">
            <div class="terminal-header"><span><i class="fas fa-users mr-2"></i>ACTIVE_WORKLOAD</span></div>
            <div class="p-4 bg-[#0d1117] h-40">
                <canvas id="workloadChart"></canvas>
            </div>
        </div>
    </div>

    {% else %}
    <!-- ADMIN VIEW (System) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="terminal-card rounded overflow-hidden">
            <div class="terminal-header"><span><i class="fas fa-chart-bar mr-2"></i>WEEKLY_THROUGHPUT</span></div>
            <div class="p-4 bg-[#0d1117] h-40">
                <canvas id="adminPageChart"></canvas>
            </div>
        </div>
        <div class="terminal-card rounded overflow-hidden">
            <div class="terminal-header"><span><i class="fas fa-chart-pie mr-2"></i>TYPE_DISTRIBUTION</span></div>
            <div class="p-4 bg-[#0d1117] h-40">
                <canvas id="adminCatChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tactical Task Grid -->
    <div class="terminal-header mb-4">
        <span><i class="fas fa-th-large mr-2"></i>TACTICAL_WORKBOARD [{{ dashboard_tasks|length }} Pending]</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {% for pg in dashboard_tasks %}
        <div
            class="p-4 rounded border border-border bg-[#0d1117] flex flex-col justify-between hover:border-primary/50 transition-colors group relative">

            <!-- Header: Priority & Status -->
            <div class="flex items-start justify-between mb-3">
                <!-- Priority -->
                {% if pg.priority.value == 'critical' %}
                <span
                    class="px-2 py-0.5 rounded bg-[#da3633]/10 text-[#da3633] text-[10px] border border-[#da3633]/30 font-bold uppercase tracking-wider">CRITICAL</span>
                {% elif pg.priority.value == 'high' %}
                <span
                    class="px-2 py-0.5 rounded bg-[#d29922]/10 text-[#d29922] text-[10px] border border-[#d29922]/30 uppercase tracking-wider">HIGH</span>
                {% elif pg.priority.value == 'medium' %}
                <span
                    class="px-2 py-0.5 rounded bg-[#58a6ff]/10 text-[#58a6ff] text-[10px] border border-[#58a6ff]/30 uppercase tracking-wider">MED</span>
                {% else %}
                <span
                    class="px-2 py-0.5 rounded bg-[#8b949e]/10 text-[#8b949e] text-[10px] border border-[#8b949e]/30 uppercase tracking-wider">LOW</span>
                {% endif %}

                <!-- Quick Status Switcher -->
                <select onchange="updateTaskStatus({{ pg.id }}, this.value)"
                    class="bg-[#21262d] border border-[#30363d] text-[10px] rounded px-2 py-1 text-white focus:outline-none focus:border-primary cursor-pointer hover:border-muted
                    {% if pg.status.value == 'todo' %}text-gray-400{% elif pg.status.value == 'in_progress' %}text-blue-400 border-blue-900/30{% elif pg.status.value == 'done' %}text-green-400 border-green-900/30{% endif %}">
                    <option value="todo" {% if pg.status.value=='todo' %}selected{% endif %}>To Do</option>
                    <option value="in_progress" {% if pg.status.value=='in_progress' %}selected{% endif %}>In Progress
                    </option>
                    <option value="done" {% if pg.status.value=='done' %}selected{% endif %}>Done</option>
                </select>
            </div>

            <!-- Body: Title & Excerpt -->
            <div class="mb-4">
                <a href="/calendar"
                    class="text-sm font-bold text-white group-hover:text-primary transition-colors block mb-1">
                    {{ pg.title }}
                </a>
                <p class="text-[11px] text-muted line-clamp-2 leading-relaxed">
                    {{ pg.content[:100] }}{% if pg.content|length > 100 %}...{% endif %}
                </p>
            </div>

            <!-- Footer: Meta -->
            <div class="flex items-center justify-between pt-3 border-t border-[#21262d] mt-auto">
                <div class="flex items-center">
                    <div class="w-5 h-5 rounded-full bg-[#30363d] flex items-center justify-center text-[9px] text-white border border-border mr-2"
                        title="Assignee">
                        {{ pg.assignee.username[0].upper() if pg.assignee else '?' }}
                    </div>
                    <span class="text-[10px] text-muted">{{ pg.category.value }}</span>
                </div>

                <div
                    class="flex items-center text-[10px] {% if pg.end_time and pg.end_time < now %}text-danger{% else %}text-muted{% endif %}">
                    <i class="far fa-clock mr-1"></i>
                    {% if pg.end_time %}
                    {{ pg.end_time.strftime('%d %b') }}
                    {% else %}
                    No Date
                    {% endif %}
                </div>
            </div>

        </div>
        {% else %}
        <div class="col-span-full py-12 text-center border dashed border-[#30363d] rounded text-muted">
            <i class="fas fa-check-circle text-4xl mb-3 opacity-20"></i>
            <p>All clear. No active tasks found.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/app.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        initDashboard();
    });
</script>
{% endblock %}